---
title: "DBS Effects: Data Analysis"
---

# Packages
```{r}
library(tidyverse) # install.packages("rlang")

library(ggrepel)
library(sp)

library(ggpubr)
library(lmerTest) # install.packages("lmerTest")
library(performance) # install.packages("performance")
library(patchwork)
library(gt)

```

# Load the Data
```{r}
dir.create(path = "Figures/Acoustic Data", showWarnings = F)

speakerList <- rio::import("DBS data/Project Progress - Speakers.csv") %>%
  dplyr::rename(DBS_Status = 3) %>%
  dplyr::mutate(Sex = as.factor(Sex),
                Group = as.factor(Group),
                Speaker = as.factor(Speaker),
                DBS_Status = as.factor(DBS_Status))

SpeakerSex <- speakerList |>
  dplyr::select(Speaker, Sex) |>
  unique()

# Artic Rate ----
ArticRate <- rio::import("Prepped Data/Artic Rate.csv") |>
    dplyr::mutate(Group = as.factor(Group),
                  Speaker = as.factor(Speaker),
                  DBS_Status = as.factor(DBS_Status),
                  Segment = "BabyBirds") |>
  base::merge(SpeakerSex) |>
  dplyr::relocate(Sex, .after = Group)


# F2 Slope ----
F2Slope <- rio::import("Prepped Data/F2 Slope Data.csv") |>
    dplyr::mutate(Group = as.factor(Group),
                  Speaker = as.factor(Speaker),
                  DBS_Status = as.factor(DBS_Status)) |>
  base::merge(SpeakerSex) |>
  dplyr::relocate(Sex, .after = Group)

# Corner Dispersion
cornerDisp <- rio::import("Prepped Data/CornerDisp.csv") |>
    dplyr::mutate(Group = as.factor(Group),
                  Speaker = as.factor(Speaker),
                  DBS_Status = as.factor(DBS_Status),
                  Word = as.factor(Word)) |>
  base::merge(SpeakerSex) |>
  dplyr::relocate(Sex, .after = Group)

# dB Data
dBData <- rio::import("Prepped Data/dB Data.csv") |>
    dplyr::mutate(Group = as.factor(Group),
                  Speaker = as.factor(Speaker),
                  DBS_Status = ifelse(grepl(pattern = "On",
                                            DBS_Status,
                                            ignore.case = T),
                                      "On",
                                      DBS_Status),
                  DBS_Status = ifelse(grepl(pattern = "Off",
                          DBS_Status,
                          ignore.case = T),
                    "Off",
                    DBS_Status),
                  DBS_Status = as.factor(DBS_Status)) |>
  base::merge(SpeakerSex) |>
  dplyr::relocate(Sex, .after = Group)

# F0 Data
f0Data <- rio::import("Prepped Data/F0 Data.csv") |>
    dplyr::mutate(Group = as.factor(Group),
                  Speaker = as.factor(Speaker),
                  DBS_Status = ifelse(grepl(pattern = "On",
                                            DBS_Status,
                                            ignore.case = T),
                                      "On",
                                      DBS_Status),
                  DBS_Status = ifelse(grepl(pattern = "Off",
                          DBS_Status,
                          ignore.case = T),
                    "Off",
                    DBS_Status),
                  DBS_Status = as.factor(DBS_Status),
                  F0_Semitone = ifelse(F0_Semitone < -20,NA,F0_Semitone)) |>
  base::merge(SpeakerSex) |>
  dplyr::relocate(Sex, .after = Group)

alpha <- .05 / 7
```


# Speaking Rate
```{r, eval = F}
speakingRate_BabyBirds <- rio::import("Prepped Data/Speaking Rate.csv") |>
    dplyr::mutate(Group = as.factor(Group),
                  Speaker = as.factor(Speaker),
                  DBS_Status = as.factor(DBS_Status),
                  Segment = "BabyBirds") |>
  base::merge(SpeakerSex) |>
  dplyr::relocate(Sex, .after = Group)

speakingRate_bbp <- rio::import("Prepped Data/Speaking Rate_bbap.csv") |>
    dplyr::mutate(Group = as.factor(Group),
                  Speaker = as.factor(Speaker),
                  DBS_Status = as.factor(DBS_Status),
                  Segment = "bbp") |>
  dplyr::rename(speakingRate = SpeakingRate) |>
  base::merge(SpeakerSex) |>
  dplyr::relocate(Sex, .after = Group)

speakingRate <- rbind(speakingRate_BabyBirds, speakingRate_bbp) |>
  dplyr::mutate(Segment = as.factor(Segment))
```

Vowel Duration
```{r}
# Vowel Duration
vowelData <- rio::import("Prepped Data/Vowel Data.csv") |>
    dplyr::mutate(Group = as.factor(Group),
                  Speaker = as.factor(Speaker),
                  DBS_Status = as.factor(DBS_Status),
                  Word = as.factor(Word)) |>
  base::merge(SpeakerSex) |>
  dplyr::relocate(Sex, .after = Group)

# Buy Duration
buyDur <- rio::import("Prepped Data/Buy Duration.csv") |>
    dplyr::mutate(Group = as.factor(Group),
                  Speaker = as.factor(Speaker),
                  DBS_Status = as.factor(DBS_Status)) |>
  base::merge(SpeakerSex) |>
  dplyr::relocate(Sex, .after = Group)
  
rm(SpeakerSex)

```

# 1. Voicing Proportion

Model Data
```{r}
modelData <- f0Data |>
  dplyr::filter(Group == "PD_DBS")
```

M0
Fully Unconditional Model
```{r}
f0Data_m0 <- lmerTest::lmer(F0_perActive ~ 1 + (1|Speaker), data = modelData)
summary(f0Data_m0)

performance::icc(f0Data_m0)
```
M1
```{r}

f0Data_m1 <- lmerTest::lmer(F0_perActive ~ DBS_Status + (1|Speaker), data = modelData)
summary(f0Data_m1)

performance::check_model(f0Data_m1)
performance::check_singularity(f0Data_m1)

anova(f0Data_m0, f0Data_m1)
```
M2
```{r}

f0Data_m2 <- lmerTest::lmer(F0_perActive ~ DBS_Status + Sex + (1|Speaker), data = modelData)
summary(f0Data_m2)

performance::check_model(f0Data_m2)
performance::check_singularity(f0Data_m2)

anova(f0Data_m1, f0Data_m2)
```
M3
```{r}
f0Data_m3 <- lmerTest::lmer(F0_perActive ~ DBS_Status*Sex + (1|Speaker), data = modelData)
summary(f0Data_m3)

performance::check_model(f0Data_m3)
performance::check_singularity(f0Data_m3)

anova(f0Data_m2, f0Data_m3)
```

## Final Model
```{r}
f0Data_fm <- f0Data_m1
summary(f0Data_fm)
```

# 2. F2 Slope
Model  Data
```{r}
modelData <- F2Slope |>
  dplyr::filter(Group == "PD_DBS") |>
  dplyr::mutate(Sex = factor(Sex, levels = c("F","M")))
```

M0
Fully Unconditional Model
```{r}
F2Slope_m0 <- lmerTest::lmer(F2_Slope ~ 1 + (1|Speaker), data = modelData)
summary(F2Slope_m0)

performance::icc(F2Slope_m0)
```
M1
```{r}
F2Slope_m1 <- lmerTest::lmer(F2_Slope ~ DBS_Status + (1|Speaker), data = modelData)
summary(F2Slope_m1)

performance::check_model(F2Slope_m1)
performance::check_singularity(F2Slope_m1)

anova(F2Slope_m0, F2Slope_m1)
```

M2
```{r}
F2Slope_m2 <- lmerTest::lmer(F2_Slope ~ DBS_Status + Sex + (1|Speaker), data = modelData)
summary(F2Slope_m2)

performance::check_model(F2Slope_m2)
performance::check_singularity(F2Slope_m2)

anova(F2Slope_m1, F2Slope_m2)
```
M3
```{r}
F2Slope_m3 <- lmerTest::lmer(F2_Slope ~ DBS_Status*Sex + (1|Speaker), data = modelData)
summary(F2Slope_m3)

performance::check_model(F2Slope_m3)
performance::check_singularity(F2Slope_m3)

anova(F2Slope_m2, F2Slope_m3)
```
## Final Model
```{r}
F2Slope_fm <- F2Slope_m1
summary(F2Slope_fm)
```

# 3. Corner Dispersion
Model Data
```{r}
modelData <- cornerDisp |>
  dplyr::filter(Group == "PD_DBS") |>
  dplyr::mutate(Sex = factor(Sex, levels = c("F","M")))
```

M0
Fully Unconditional Model
```{r}
cornerDisp_m0 <- lmerTest::lmer(eucDist ~ 1 + (1|Speaker) + (1|Word), data = modelData)
summary(cornerDisp_m0)
performance::icc(cornerDisp_m0)
```
M1
```{r}
cornerDisp_m1 <- lmerTest::lmer(eucDist ~ DBS_Status + (1|Speaker) + (1|Word), data = modelData)
summary(cornerDisp_m1)

performance::check_singularity(cornerDisp_m1)

anova(cornerDisp_m0, cornerDisp_m1)
```

M2
```{r}
cornerDisp_m2 <- lmerTest::lmer(eucDist ~ DBS_Status + Sex + (1|Speaker) + (1|Word), data = modelData)
summary(cornerDisp_m2)

performance::check_model(cornerDisp_m2)
performance::check_singularity(cornerDisp_m2)

anova(cornerDisp_m1, cornerDisp_m2)
```

M3
```{r}
cornerDisp_m3 <- lmerTest::lmer(eucDist ~ DBS_Status*Sex + (1|Speaker) + (1|Word), data = modelData)
summary(cornerDisp_m3)

performance::check_model(cornerDisp_m3)
performance::check_singularity(cornerDisp_m3)

anova(cornerDisp_m2, cornerDisp_m3)
```
## Final Model
```{r}
cornerDisp_fm <- cornerDisp_m1
summary(cornerDisp_fm)
```

# 4. Artic Rate
Model Data
```{r}
modelData <- ArticRate |>
  dplyr::filter(Group == "PD_DBS")
```

M0
Fully Unconditional Model
```{r}
articRate_m0 <- lmerTest::lmer(articRate ~ 1 + (1|Speaker), data = modelData)
summary(articRate_m0)

performance::icc(articRate_m0)
```
M1
```{r}

articRate_m1 <- lmerTest::lmer(articRate ~ DBS_Status + (1|Speaker), data = modelData)
summary(articRate_m1)

performance::check_model(articRate_m1)
performance::check_singularity(articRate_m1)

anova(articRate_m0, articRate_m1)
```
M2
```{r}

articRate_m2 <- lmerTest::lmer(articRate ~ DBS_Status + Sex + (1|Speaker), data = modelData)
summary(articRate_m2)

performance::check_model(articRate_m2)
performance::check_singularity(articRate_m2)

anova(articRate_m1, articRate_m2)
```
M3
```{r}

articRate_m3 <- lmerTest::lmer(articRate ~ DBS_Status*Sex + (1|Speaker), data = modelData)
summary(articRate_m3)

performance::check_model(articRate_m3)
performance::check_singularity(articRate_m3)

anova(articRate_m2, articRate_m3)
```
## Final Model
```{r}
articRate_fm <- articRate_m1
summary(articRate_fm)
```


# 5. F0 Semitone
Model Data
```{r}
modelData <- f0Data |>
  dplyr::filter(Group == "PD_DBS")
```

M0 - Fully Unconditional Model
```{r}
F0_Semitone_m0 <- lmerTest::lmer(F0_Semitone ~ 1 + (1|Speaker), data = modelData)
summary(F0_Semitone_m0)

performance::icc(F0_Semitone_m0)
```
M1
```{r}

F0_Semitone_m1 <- lmerTest::lmer(F0_Semitone ~ DBS_Status + (1|Speaker), data = modelData)
summary(F0_Semitone_m1)

performance::check_model(F0_Semitone_m1)
performance::check_singularity(F0_Semitone_m1)

anova(F0_Semitone_m0, F0_Semitone_m1)
```
M2
```{r}

F0_Semitone_m2 <- lmerTest::lmer(F0_Semitone ~ DBS_Status + Sex + (1|Speaker), data = modelData)
summary(F0_Semitone_m2)

performance::check_model(F0_Semitone_m2)
performance::check_singularity(F0_Semitone_m2)

anova(F0_Semitone_m1, F0_Semitone_m2)
```
M3
```{r}

F0_Semitone_m3 <- lmerTest::lmer(F0_Semitone ~ DBS_Status*Sex + (1|Speaker), data = modelData)
summary(F0_Semitone_m3)

performance::check_model(F0_Semitone_m3)
performance::check_singularity(F0_Semitone_m3)

anova(F0_Semitone_m2, F0_Semitone_m3)
```
## Final Model
```{r}
F0_Semitone_fm <- F0_Semitone_m1
summary(F0_Semitone_fm)
```

# 6. dB Range
Model Data
```{r}
modelData <- dBData |>
  dplyr::filter(Group == "PD_DBS")
```

M0 - Fully Unconditional Model
```{r}
dB_range_m0 <- lmerTest::lmer(dB_range ~ 1 + (1|Speaker), data = modelData)
summary(dB_range_m0)

performance::icc(dB_range_m0)
```
M1
```{r}

dB_range_m1 <- lmerTest::lmer(dB_range ~ 1 + DBS_Status + (1|Speaker), data = modelData)
summary(dB_range_m1)

performance::check_model(dB_range_m1)
performance::check_singularity(dB_range_m1)

anova(dB_range_m0, dB_range_m1)
```
## Final Model
```{r}
dB_range_fm <- dB_range_m1
summary(dB_range_fm)
```

# Model Table
```{r}
sjPlot::tab_model(
  f0Data_fm,
  F2Slope_fm,
  cornerDisp_fm,
  articRate_fm,
  F0_Semitone_fm,
  dB_range_fm,
  show.p = T,
  #show.reflvl = T,
  show.ci = F,
  p.style = "stars",
  p.threshold = c(.007),
  emph.p = T,
  pred.labels = c(
  "(Intercept) DBS-Off",
  "DBS-On"),
  dv.labels = c("Voicing Proportion (%)",
                "F2 Slope (Hz/ms)",
                "Vowel Dispersion (Hz)",
                "Articulation Rate (syl/s)",
                "F0 Variation (Semitone)",
                "Intensity Variation (dB)")
)
```


# Plots
General info for plots
```{r}
pointSize <- 3
```

## All Acoustic Measures
```{r}
# Voicing Proportion ----
plotData_F0_perActive <- f0Data %>%
  dplyr::filter(Group == "PD_DBS") %>%
  dplyr::group_by(Speaker,Sex,DBS_Status) %>%
  dplyr::summarise(F0_perActive = mean(F0_perActive, na.rm = T)) %>%
  tidyr::pivot_longer(cols = F0_perActive,
                      names_to = "Measure",
                      values_to = "Value")
# F2 Slope ----
plotData_F2Slope <- F2Slope %>%
  dplyr::filter(Group == "PD_DBS") %>%
  dplyr::group_by(Speaker,Sex,DBS_Status) %>%
  dplyr::summarise(F2_Slope = mean(F2_Slope, na.rm = T)) %>%
  tidyr::pivot_longer(cols = F2_Slope,
                      names_to = "Measure",
                      values_to = "Value")
# Corner Dispersion ----
plotData_cornerDisp <- cornerDisp |>
  dplyr::filter(Group == "PD_DBS") |>
  dplyr::mutate(Sex = factor(Sex, levels = c("F","M"))) %>%
  dplyr::group_by(Speaker, Sex, DBS_Status) |>
  dplyr::summarize(eucDist = mean(eucDist, na.rm = T)) |>
  dplyr::ungroup() %>%
  tidyr::pivot_longer(cols = eucDist,
                      names_to = "Measure",
                      values_to = "Value")
# Artic Rate ----
plotData_articRate <- ArticRate |>
  dplyr::filter(Group == "PD_DBS") %>%
  dplyr::group_by(Speaker, Sex, DBS_Status) |>
  dplyr::summarise(articRate = mean(articRate, na.rm = T)) %>%
  tidyr::pivot_longer(cols = articRate,
                      names_to = "Measure",
                      values_to = "Value")

# F0 Semitone ----
plotData_F0variation <- f0Data %>%
  dplyr::filter(Group == "PD_DBS") %>%
  dplyr::group_by(Speaker,Sex,DBS_Status) %>%
  dplyr::summarise(F0_Semitone = mean(F0_Semitone, na.rm = T)) %>%
  tidyr::pivot_longer(cols = F0_Semitone,
                      names_to = "Measure",
                      values_to = "Value")

# dB Variation ----
plotData_dBvariation <- dBData |>
  dplyr::filter(Group == "PD_DBS") %>%
  dplyr::group_by(Speaker,Sex,DBS_Status) %>%
  dplyr::summarise(dB_range = mean(dB_range, na.rm = T)) %>%
  tidyr::pivot_longer(cols = dB_range,
                      names_to = "Measure",
                      values_to = "Value")

plotData <- rbind(
  plotData_F0_perActive,
  plotData_F2Slope,
  plotData_cornerDisp,
  plotData_articRate,
  plotData_F0variation,
  plotData_dBvariation
) %>%
  dplyr::mutate(Speaker = factor(Speaker,
                                 levels = c(
                                   "PDDBS1",
                                   "PDDBS2",
                                   "PDDBS4",
                                   "PDDBS5",
                                   "PDDBS6",
                                   "PDDBS7",
                                   "PDDBS8",
                                   "PDDBS9",
                                   "PDDBS11"
                                   ),
                                 labels = c(
                                   "PD-DBS1",
                                   "PD-DBS2",
                                   "PD-DBS4",
                                   "PD-DBS5",
                                   "PD-DBS6",
                                   "PD-DBS7",
                                   "PD-DBS8",
                                   "PD-DBS9",
                                   "PD-DBS11"
                                 )),
                Measure = factor(Measure,
                                 levels = c(
                                   "F0_perActive",
                                   "F2_Slope",
                                   "eucDist",
                                   "articRate",
                                   "F0_Semitone",
                                   "dB_range"
                                 ),
                                 labels = c(
                                   "Voicing Proportion (%)",
                                   "F2 Slope (Hz/ms)",
                                   "Vowel Dispersion (Hz)",
                                   "Articulation Rate (syl/s)",
                                   "F0 Range (Semitone)",
                                   "Intensity Range (dB)"
                                   )),
                label = gsub("[^0-9.-]", "", Speaker),
                label = gsub("-", "", label))

plot <- plotData %>%
  ggplot() +
  aes(x = DBS_Status,
      y = Value,
      group = Speaker) +
  
  # Plotting the line
  geom_line(
    color = "black",
    linetype = "longdash",
    position = position_dodge(width = 0.3)) +
  
  # Plotting the points for each speaker
  geom_point(
    size = pointSize,
    position = position_dodge(width = 0.3)) +

  # Labels
  geom_text(aes(label = label),
            color = "white",
            size = 2,
            fontface = "bold",
    position = position_dodge(width = 0.3)) +
  
  # Mean line
  geom_smooth(method = "lm",
              show.legend = T,
              se = F,
              inherit.aes = F,
              aes(x = DBS_Status,
                  y = Value,
                  group = Measure)) +
  
  # Scaling & fixing the theme
  labs(x = "DBS Status",
       y = "") +
  
  # Wrap by Measure
  facet_wrap(~Measure, scales = "free_y") +
  
  theme_classic() +
  theme(aspect.ratio = 1)

plot

ggsave(filename = "Figures/Acoustic Measures.png",
       plot = plot,
       height = 4,
       width = 6,
       units = "in",
       scale = 1.2)
```

## Vowel Dispersion by vowel
```{r}
# Corner Dispersion ----
plotData_cornerDisp <- cornerDisp |>
  dplyr::filter(Group == "PD_DBS") |>
  dplyr::mutate(Sex = factor(Sex, levels = c("F","M"))) %>%
  dplyr::group_by(Speaker, Sex, Word, DBS_Status) |>
  dplyr::summarize(eucDist = mean(eucDist, na.rm = T)) |>
  dplyr::ungroup() %>%
  tidyr::pivot_longer(cols = eucDist,
                      names_to = "Measure",
                      values_to = "Value") %>%
  dplyr::mutate(Speaker = factor(Speaker,
                                 levels = c(
                                   "PDDBS1",
                                   "PDDBS2",
                                   "PDDBS4",
                                   "PDDBS5",
                                   "PDDBS6",
                                   "PDDBS7",
                                   "PDDBS8",
                                   "PDDBS9",
                                   "PDDBS11"
                                   ),
                                 labels = c(
                                   "PD-DBS1",
                                   "PD-DBS2",
                                   "PD-DBS4",
                                   "PD-DBS5",
                                   "PD-DBS6",
                                   "PD-DBS7",
                                   "PD-DBS8",
                                   "PD-DBS9",
                                   "PD-DBS11"
                                 )),
                Measure = factor(Measure,
                                 levels = c(
                                   "F0_perActive",
                                   "F2_Slope",
                                   "eucDist",
                                   "articRate",
                                   "F0_Semitone",
                                   "dB_range"
                                 ),
                                 labels = c(
                                   "Voicing Proportion (%)",
                                   "F2 Slope (Hz/ms)",
                                   "Vowel Dispersion (Hz)",
                                   "Articulation Rate (syl/s)",
                                   "F0 Range (Semitone)",
                                   "Intensity Range (dB)"
                                   )),
                Word = factor(Word, 
                              levels = c(
                                "bat",
                                "bots",
                                "beets",
                                "boots"
                              ),
                              labels = c(
                                "bat",
                                "bot",
                                "beet",
                                "boot"
                              )),
                label = gsub("[^0-9.-]", "", Speaker),
                label = gsub("-", "", label))

plot_vowelDisp <- plotData_cornerDisp %>%
  ggplot() +
  aes(x = DBS_Status,
      y = Value,
      group = Speaker) +
  
    # Plotting the line
  geom_line(
    color = "black",
    linetype = "longdash",
    position = position_dodge(width = 0.3)) +
  
  # Plotting the points for each speaker
  geom_point(
    size = pointSize,
    position = position_dodge(width = 0.3)) +

  # Labels
  geom_text(aes(label = label),
            color = "white",
            size = 2,
            fontface = "bold",
    position = position_dodge(width = 0.3)) +
  
  # Mean line
  geom_smooth(method = "lm",
              show.legend = T,
              se = F,
              inherit.aes = F,
              aes(x = DBS_Status,
                  y = Value,
                  group = Measure)) +
  
  # Scaling & fixing the theme
  labs(x = "DBS Status",
       y = "") +
  
  # Wrap by Measure
  facet_wrap(~Word, scales = "free_y") +
  
  theme_classic() +
  theme(aspect.ratio = 1)

plot_vowelDisp

ggsave(filename = "Figures/Vowel Dispersion by Vowel.png",
       plot = plot_vowelDisp,
       height = 4,
       width = 4,
       units = "in",
       scale = 1.3)
```

