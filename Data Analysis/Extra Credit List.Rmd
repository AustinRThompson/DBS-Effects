---
title: "Extra Credit"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Cmd+Shift+Enter*. 

```{r}
plot(cars)
```

```{r}
## Load the Data
```{r}
perceptualData <- rio::import(file = paste("Raw Data/",
                                           list.files(path = "Raw Data",
                                                      pattern = "Perceptual Study"),
                                           sep = ""),
                              header = FALSE)

perceptualData[2,1:32] <- NA
perceptualData[2,] <- sub('\\-.*', '', perceptualData[2,])
perceptualData[1,33:352] <- NA
perceptualData[3,] <- NA
# Rating Type
perceptualData[3,c(33:64, 193:224)] <- "Int"
perceptualData[3,c(65:96, 225:256)] <- "LE"
perceptualData[3,c(97:128, 257:288)] <- "AP"
perceptualData[3,c(129:160, 289:320)] <- "VQ"
perceptualData[3,c(161:192, 321:352)] <- "Pro"

headings <- as.data.frame(lapply(perceptualData[1:3,], paste,collapse="_")) %>%
    str_remove_all(" ") %>%
    str_remove_all("_NA") %>%
    str_remove_all("NA_") %>%
    t() %>%
    as.data.frame()
colnames(perceptualData) <- headings
    perceptualData <- perceptualData[-c(1:3),]
    
    rm(headings)
    
perceptualData <- perceptualData |>
  dplyr::rename(class = 19,
                class_other = Q1_6_TEXT,
                email = 21,
                inUS = 22,
                english = 23,
                age = 24,
                gender = 25,
                gender_other = 26,
                race = 27,
                race_other = 28,
                ethnicity = 29,
                audioCheck = 30) |>
  dplyr::select(!c(32, StartDate:EndDate,IPAddress,ResponseId:UserLanguage)) |>
  dplyr::filter(Finished == "True") |>
  dplyr::filter(Status == "IP Address") |>
  #dplyr::filter(english == "Yes, it is my native language") |>
  dplyr::mutate(across(.cols=20:339, .fns=as.numeric)) |>
  dplyr::mutate(ListenerID = paste("L",row_number(), sep = ""),
                ListenerID = as.factor(ListenerID)) |>
  dplyr::relocate(ListenerID, .before = 1)

listenerDemo <- perceptualData |>
  dplyr::select(ListenerID:Headphones)

rio::export(listenerDemo |>
              dplyr::filter(class == "SPA 5230: Motor Speech Disorders") |>
              dplyr::select(ListenerID, email, english),
            file = "Prepped Data/Perceptual Data/MSD Extra Credit.xlsx",
            format = "xlsx")

listenerRatings <- perceptualData |>
  dplyr::select(ListenerID,HC1_Int:PDDBS9_On_Rel_Pro) |>
  tidyr::pivot_longer(cols = `HC1_Int`:`PDDBS9_On_Rel_Pro`,
                      names_to = "RatingID",
                      values_to = "Rating") |>
  dplyr::filter(!is.na(Rating)) |>
  dplyr::mutate(
    # Making the Rating Type column
    ratingType = case_when(
      grepl(pattern = "_Int",
            fixed = T,
            x = RatingID) ~ "Int",
      grepl(pattern = "_LE",
            fixed = T,
            x = RatingID) ~ "LE",
      grepl(pattern = "_AP",
            fixed = T,
            x = RatingID) ~ "AP",
      grepl(pattern = "_VQ",
            fixed = T,
            x = RatingID) ~ "VQ",
      grepl(pattern = "_Pro",
            fixed = T,
            x = RatingID) ~ "Pro"),
    ratingType = as.factor(ratingType),
    
    # Making the DBS Status column
    DBS_Status = case_when(
       grepl(pattern = "_On",
          ignore.case = T,
          x = RatingID) ~ "On",
       grepl(pattern = "_Off",
          ignore.case = T,
          x = RatingID) ~ "Off"),
    DBS_Status = as.factor(DBS_Status),
    
    # Making the Speaker ID column
    Speaker = sub('\\_.*', '', RatingID),
    Speaker = as.factor(Speaker),
    
    # Making the Speaker Group column
    Group = case_when(
      grepl(pattern = "HC",
          ignore.case = T,
          x = RatingID) ~ "HC",
      grepl(pattern = "PDDBS",
          ignore.case = T,
          x = RatingID) ~ "PD_DBS",
      grepl(pattern = "PD",
          ignore.case = T,
          x = RatingID) ~ "PD"),
    Group = as.factor(Group),
    
    # Identifying Reliability Ratings
    Reliability = case_when(
      grepl(pattern = "_Rel",
            ignore.case = T,
            x = RatingID) ~ TRUE,
      TRUE ~ FALSE)
    ) |>
  dplyr::select(ListenerID, Speaker, Group, DBS_Status, ratingType, Rating, Reliability)

relRatings <- listenerRatings |>
  dplyr::filter(Reliability == TRUE) |>
  dplyr::rename(Rel_Rating = Rating) |>
  dplyr::select(!Reliability)

listenerRatings <- listenerRatings |>
  dplyr::filter(Reliability == FALSE) |>
  dplyr::select(!Reliability) |>
  base::merge(relRatings,
              all = T)
```
```


