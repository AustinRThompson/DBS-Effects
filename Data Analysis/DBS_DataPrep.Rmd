---
title: "DBS Effects: Data Prep"
---

# Packages
```{r}
library(tidyverse) # install.packages("rlang")
library(rio) # install.packages("rio")
library(rPraat) # install.packages("rPraat")
library(ggrepel) # install.packages("ggrepel")
```

# function
```{r}
eucDist <- function(x1,y1,x2,y2) {
  df <- data.frame(x1,y1,x2,y2) |>
    dplyr::mutate(eucDist = base::sqrt((x2 - x1)^2 + (y2 - y1)^2)) |>
    dplyr::select(eucDist)

  return(df)
}
```

# Acoustic Data
## Load the Data
```{r}
speakerList <- rio::import("DBS data/Project Progress - Speakers.csv") %>%
  dplyr::rename(DBS_Status = 3) %>%
  dplyr::mutate(Sex = as.factor(Sex),
                Group = as.factor(Group),
                Speaker = as.factor(Speaker),
                DBS_Status = as.factor(DBS_Status))

speakerList_vowels <- speakerList %>%
  dplyr::filter(eeahoo == TRUE)

speakerList_articRate <- speakerList %>%
  dplyr::select(Speaker:Age,Sent2:`Sent2 File`) %>%
  dplyr::filter(Sent2 == TRUE)

speakerList_BBAP <- speakerList %>%
  dplyr::select(Speaker:Age,`BBAP File`) |>
  dplyr::filter(grepl("PD",`BBAP File`))

  
```

### Generating .lbl files for TF 32
```{r, eval = F}
k <- 1

while (k <= nrow(speakerList_vowels)) {
Speaker <- speakerList_vowels$Speaker[k]
Group <- speakerList_vowels$Group[k]
vowelFile <- speakerList_vowels$`Vowel File`[k]

filePath <- paste("DBS data/",Group,"/",Speaker,"/", sep = "")

tg <- list.files(path = filePath, pattern = paste(vowelFile,".TextGrid",sep = "")) %>%
    paste(filePath,.,sep = "") %>%
    tg.read(.)

Segments <- cbind(tg[[1]][["label"]],tg[[1]][["t1"]], tg[[1]][["t2"]]) %>%
  rbind(cbind(tg[[2]][["label"]],tg[[2]][["t1"]], tg[[2]][["t2"]])) %>%
    as.data.frame() %>%
    dplyr::rename(Segment = 1,
                  Onset = 2,
                  Offset = 3) %>%
  dplyr::filter(Segment != "")

lbl <- Segments %>%
  dplyr::select(Onset, Offset, Segment) %>%
  dplyr::mutate(Onset = as.numeric(Onset)*1000,
                Offset = as.numeric(Offset)*1000)

outputFile <- list.files(path = filePath,
                         all.files = T,
                         ignore.case = T,
                         pattern = paste(vowelFile,".TextGrid",sep = "")) %>%
  paste(filePath,., sep = "") %>%
  gsub(".TextGrid",".lbl",.)

write_delim(lbl,
            file = outputFile,
            col_names = FALSE)

rm(Speaker, Group, vowelFile, filePath, Segments, lbl, outputFile)

k <- k + 1
}

```

## Vowel Analysis
```{r, eval = F}
vowelData <- readxl::read_xlsx(path = "Raw Data/Results.xlsx",
                               sheet = "AVS") |>
  dplyr::select(1:17) |>
  dplyr::rename(Speaker = 1,
                F1_bat = 3,
                F2_bat = 4,
                dur_bat = 5,
                F1_beets = 7,
                F2_beets = 8,
                dur_beets = 9,
                F1_boots = 11,
                F2_boots = 12,
                dur_boots = 13,
                F1_bots = 15,
                F2_bots = 16,
                dur_bots = 17) |>
  dplyr::mutate(BAT = "BAT",
                BEETS = "BEETS",
                BOOTS = "BOOTS",
                BOTS = "BOTS") |>
  dplyr::filter(!is.na(Speaker))

rawVowelData <- vowelData |>
  dplyr::mutate(F1_boots = as.character(F1_boots))

vowelData_BAT <- rawVowelData |>
  dplyr::select(Speaker, F1_bat, F2_bat, dur_bat) |>
  dplyr::rename(F1 = 2,
                F2 = 3,
                Duration = 4) |>
  dplyr::mutate(Word = "bat")

vowelData_BEETS <- rawVowelData |>
  dplyr::select(Speaker, F1_beets, F2_beets, dur_beets) |>
  dplyr::rename(F1 = 2,
                F2 = 3,
                Duration = 4) |>
  dplyr::mutate(Word = "beets")

vowelData_BOOTS <- rawVowelData |>
  dplyr::select(Speaker, F1_boots, F2_boots, dur_boots) |>
  dplyr::rename(F1 = 2,
                F2 = 3,
                Duration = 4) |>
  dplyr::mutate(Word = "boots")

vowelData_BOTS <- rawVowelData |>
  dplyr::select(Speaker, F1_bots, F2_bots, dur_bots) |>
  dplyr::rename(F1 = 2,
                F2 = 3,
                Duration = 4) |>
  dplyr::mutate(Word = "bots")

vowelData <- rbind(vowelData_BAT,
                   vowelData_BEETS,
                   vowelData_BOOTS,
                   vowelData_BOTS) |>
  dplyr::filter(!is.na(F2)) |>
  dplyr::mutate(F1 = as.numeric(F1),
                Word = as.factor(Word),
                Group = ifelse(grepl("HC",
                                     Speaker,
                                     fixed = T), "HC", "PD"),
                Group = ifelse(grepl("DBS",
                                     Speaker,
                                     fixed = T),
                               "PD_DBS",
                               Group),
                DBS_Status = NA,
                DBS_Status = ifelse(grepl("ON",
                                          Speaker,
                                          fixed = T),
                                    "On",
                                    DBS_Status),
                DBS_Status = ifelse(grepl("OFF",
                                          Speaker,
                                          fixed = T),
                                    "Off",
                                    DBS_Status),
                Speaker = gsub("ON", "", Speaker,
                               fixed = T),
                Speaker = gsub("OFF", "", Speaker,
                               fixed = T),
                Speaker = gsub(" ", "", Speaker,
                               fixed = T),
                Speaker = as.factor(Speaker),
                Group = as.factor(Group),
                DBS_Status = as.factor(DBS_Status)) |>
  dplyr::relocate(Group:DBS_Status, .after = Speaker)

dir.create("Prepped Data", showWarnings = F)
rio::export(vowelData, file = "Prepped Data/Vowel Data.csv", format = "csv")

```

## Corner Dispersion
```{r}
cornerDisp <- rio::import(file = "Prepped Data/Vowel Data.csv") |>
  dplyr::mutate(Speaker = as.factor(Speaker),
                Group = as.factor(Group),
                DBS_Status = as.factor(DBS_Status),
                Word = as.factor(Word)) |>
  dplyr::group_by(Speaker, DBS_Status) |>
  dplyr::mutate(F1_med = median(F1),
                F2_med = median(F2)) |>
  dplyr::ungroup() |>
  dplyr::mutate(cornerDisp = eucDist(x1 = F1,
                                     y1 = F2,
                                     x2 = F1_med,
                                     y2 = F2_med)) |>
  tidyr::unnest(cols = c(cornerDisp))

rio::export(cornerDisp, file = "Prepped Data/CornerDisp.csv")

outliers <- cornerDisp |>
  group_by(Speaker, DBS_Status, Word) |>
  dplyr::mutate(F1_z = scale(F1),
                F2_z = scale(F2),
                outlier = ifelse(abs(F1_z) > 2.5 | abs(F2_z) > 2.5,
                                   TRUE,
                                   FALSE)) |>
  dplyr::ungroup() |>
  dplyr::filter(outlier == TRUE)

rio::export(outliers, file = "Prepped Data/Outliers.csv")

```

### Example corner dispersion
```{r}
cornerDisp %>%
  dplyr::filter(Speaker == "HC1") %>%
  ggplot() +
  # Vowel Points
  geom_point(aes(x = F2,
                 y = F1,
                 color = Word)) +
  
  # Center Point
  geom_point(data = cornerDisp %>%
               dplyr::filter(Speaker == "HC1") %>%
               dplyr::group_by(Speaker) %>%
               dplyr::summarise(F1 = mean(F1_med),
                                F2 = mean(F2_med)),
             inherit.aes = F,
             aes(x = F2,
                 y = F1)) +
  
  # Lines
  geom_segment(aes(
    x = F2,
    y = F1,
    xend = F2_med,
    yend = F1_med,
    color = Word
  )) +
    
  scale_x_reverse() +
  scale_y_reverse() +
  theme_minimal() +
  theme(aspect.ratio = 1)

ggsave(filename = "Figures/Vowel Dispersion/Vowel Dispersion Example.png",
       plot = last_plot(),
       height = 3,
       width = 4,
       units = "in",
       scale = 1)
  
```

### Ploting the dispersion
```{r}
plotCornerDisp <- function(data) {
  data <- data |>
    group_by(Speaker, DBS_Status, Word) |>
    dplyr::mutate(F1_z = scale(F1),
                  F2_z = scale(F2),
                  outlier = ifelse(abs(F1_z) > 2.5 | abs(F2_z) > 2.5,
                                   TRUE,
                                   FALSE))
  
  outliers <- data |>
    dplyr::filter(outlier == TRUE)
    
   if(length(unique(data$DBS_Status)) > 1){
     ggplot(data = data) +
       aes(x = F2,
           y = F1,
           color = Word) +
  scale_x_reverse() +
  scale_y_reverse() +
  geom_point() +
  geom_point(data = data |>
               group_by(Speaker, DBS_Status) |>
               dplyr::summarise(F1_med = mean(F1_med),
                                F2_med = mean(F2_med)) |>
               dplyr::ungroup(),
             inherit.aes = F,
             aes(x = F2_med,
                 y = F1_med)) +
       geom_point(data = data |>
               dplyr::filter(outlier == TRUE),
             inherit.aes = F,
             aes(x = F2,
                 y = F1),
             color = "red") +
       geom_label_repel(data = outliers,
                        aes(label = Word),
                        alpha = .6,
                        show.legend = F,
                  size = 4,
                  box.padding = 0.5,
                  point.padding = 0.5,
                  force = 100,
                  segment.size = 0.2,
                  segment.color = "grey50") +
  facet_wrap(~Speaker*DBS_Status, ncol = 6) +
  theme_classic()
   } else {
     ggplot(data = data) +
       aes(x = F2,
        y = F1,
        color = Word) +
  scale_x_reverse() +
  scale_y_reverse() +
  geom_point() +
  geom_point(data = data |>
               group_by(Speaker, DBS_Status) |>
               dplyr::summarise(F1_med = mean(F1_med),
                                F2_med = mean(F2_med)) |>
               dplyr::ungroup(),
             inherit.aes = F,
             aes(x = F2_med,
                 y = F1_med)) +
       geom_point(data = data |>
               dplyr::filter(outlier == TRUE),
             inherit.aes = F,
             aes(x = F2,
                 y = F1),
             color = "red") +
       geom_label_repel(data = outliers,
                        aes(label = Word),
                        alpha = .6,
                        show.legend = F,
                        size = 4,
                        box.padding = 0.5,
                        point.padding = 0.5,
                        force = 100,
                        segment.size = 0.2,
                        segment.color = "grey50") +
  facet_wrap(~Speaker) +
  theme_classic()
 }

}

dir.create("Figures", showWarnings = F)
dir.create("Figures/Vowel Dispersion", showWarnings = F)

plotCornerDisp(cornerDisp |>
                 dplyr::filter(Group == "HC"))
ggsave(filename = "Figures/Vowel Dispersion/vowels_HC.png",
       plot = last_plot(),
       device = "png",
       dpi = 300)

plotCornerDisp(cornerDisp |>
                 dplyr::filter(Group == "PD"))
ggsave(filename = "Figures/Vowel Dispersion/vowels_PD.png",
       plot = last_plot(),
       device = "png",
       dpi = 300)

plotCornerDisp(cornerDisp |>
                 dplyr::filter(Group == "PD_DBS"))
ggsave(filename = "Figures/Vowel Dispersion/vowels_PD_DBS.png",
       plot = last_plot(),
       device = "png",
       height = 8,
       width = 12,
       units = "in",
       scale = .8,
       dpi = 600)

  
```

## F2 Slope
```{r}
F2Data <- readxl::read_xlsx(path = "Raw Data/F2slopes.xlsx",
                               sheet = "Sheet1",
                            col_names = c("Speaker","F2_Slope")) |>
  dplyr::mutate(Speaker = gsub("PDHC", "HC", Speaker),
                Speaker = gsub("PD HC", "HC", Speaker),
                Group = ifelse(grepl("HC",
                                     Speaker,
                                     fixed = T), "HC", "PD"),
                Group = ifelse(grepl("DBS",
                                     Speaker,
                                     fixed = T),
                               "PD_DBS",
                               Group),
                DBS_Status = NA,
                DBS_Status = ifelse(grepl("ON",
                                          Speaker,
                                          fixed = T),
                                    "On",
                                    DBS_Status),
                DBS_Status = ifelse(grepl("OFF",
                                          Speaker,
                                          fixed = T),
                                    "Off",
                                    DBS_Status),
                Speaker = gsub("ON", "", Speaker,
                               fixed = T),
                Speaker = gsub("OFF", "", Speaker,
                               fixed = T),
                Speaker = gsub(" ", "", Speaker,
                               fixed = T),
                Speaker = as.factor(Speaker),
                Group = as.factor(Group),
                DBS_Status = as.factor(DBS_Status)) |>
  dplyr::filter(!is.na(Speaker)) |>
  dplyr::relocate(Group:DBS_Status, .after = Speaker)

dir.create("Prepped Data", showWarnings = F)
rio::export(F2Data, file = "Prepped Data/F2 Slope Data.csv", format = "csv")
```


## Articulation Rate
For the "Baby Birds" sentence
```{r}
NC <- 1

while(NC <= nrow(speakerList_articRate)) {
  speaker_articRate <- speakerList_articRate %>%
    dplyr::filter(row_number() == NC)
  
  Speaker <- speaker_articRate$Speaker
  Group <- speaker_articRate$Group
  articRateFile <- speaker_articRate$`Sent2 File`
  DBSstatus <- speaker_articRate$DBS_Status

filePath <- paste("DBS data/",Group,"/",Speaker,"/", sep = "")

tg <- list.files(path = filePath, pattern = paste(articRateFile,".TextGrid",sep = "")) %>%
    paste(filePath,.,sep = "") %>%
    tg.read(.)

Segments <- cbind(tg[[1]][["label"]],tg[[1]][["t1"]], tg[[1]][["t2"]]) %>%
    as.data.frame() %>%
    dplyr::rename(Segment = 1,
                  Onset = 2,
                  Offset = 3) %>%
  dplyr::filter(Segment != "") %>%
  dplyr::mutate(Speaker = Speaker,
                Group = Group,
                DBS_Status = DBSstatus) %>%
  dplyr::relocate(Speaker:DBS_Status, .before = 1)

if(NC == 1) {
  articRate <- Segments
} else {
  articRate <- articRate %>%
    rbind(., Segments)
}

NC <- NC + 1
rm(Segments, Speaker, Group, articRateFile, DBSstatus, speaker_articRate, tg, filePath)
}

articRate <- articRate %>%
  dplyr::mutate(Onset = as.numeric(Onset),
                Offset = as.numeric(Offset),
                Duration = Offset - Onset,
                sylCount = Segment,
                sylCount = gsub("sent2","",sylCount),
                sylCount = gsub("_","",sylCount),
                sylCount = as.numeric(sylCount),
                sylCount = ifelse(is.na(sylCount),15,sylCount),
                articRate = sylCount/Duration) %>%
  dplyr::select(!Segment)

articRate_newSpeakers <- rio::import(file = "Raw Data/articRate_newSpeakerData.csv", header = TRUE) %>%
  dplyr::select(Speaker:speakingRate) %>%
  dplyr::rename(articRate = speakingRate) %>%
  dplyr::mutate(Onset = 0,
                Offset = 0)

articRate <- base::rbind(articRate,articRate_newSpeakers)
rm(articRate_newSpeakers)

dir.create("Prepped Data", showWarnings = F)
rio::export(articRate, file = "Prepped Data/Artic Rate.csv", format = "csv")

```

## Speaking Rate
```{r, eval = F}
NC <- 1

speakerList_speakingRate <- speakerList_articRate

while(NC <= nrow(speakerList_speakingRate)) {
  speaker_speakingRate <- speakerList_speakingRate %>%
    dplyr::filter(row_number() == NC)
  
  Speaker <- speaker_speakingRate$Speaker
  Group <- speaker_speakingRate$Group
  speakingRateFile <- speaker_speakingRate$`Sent2 File`
  DBSstatus <- speaker_speakingRate$DBS_Status

filePath <- paste("DBS data/",Group,"/",Speaker,"/", sep = "")

tg <- list.files(path = filePath, pattern = paste(speakingRateFile,".TextGrid",sep = "")) %>%
    paste(filePath,.,sep = "") %>%
    tg.read(.)

Segments <- cbind(tg[[2]][["label"]],tg[[2]][["t1"]], tg[[2]][["t2"]]) %>%
    as.data.frame() %>%
    dplyr::rename(Segment = 1,
                  Onset = 2,
                  Offset = 3) %>%
  dplyr::filter(Segment != "") %>%
  dplyr::mutate(Speaker = Speaker,
                Group = Group,
                DBS_Status = DBSstatus) %>%
  dplyr::relocate(Speaker:DBS_Status, .before = 1)

if(NC == 1) {
  speakingRate <- Segments
} else {
  speakingRate <- speakingRate %>%
    rbind(., Segments)
}

NC <- NC + 1
rm(Segments, Speaker, Group, speakingRateFile, DBSstatus, speaker_speakingRate, tg, filePath)
}

speakingRate <- speakingRate %>%
  dplyr::mutate(Onset = as.numeric(Onset),
                Offset = as.numeric(Offset),
                Duration = Offset - Onset,
                sylCount = Segment,
                sylCount = gsub("sent2","",sylCount),
                sylCount = gsub("_","",sylCount),
                sylCount = as.numeric(sylCount),
                sylCount = ifelse(is.na(sylCount),15,sylCount),
                speakingRate = sylCount/Duration) %>%
  dplyr::select(!Segment)

speakingRate_newSpeakers <- rio::import(file = "Raw Data/speakingRate_newSpeakerData.csv") %>%
  dplyr::select(Speaker:speakingRate) %>%
  dplyr::mutate(Onset = 0,
                Offset = 0)

speakingRate <- base::rbind(speakingRate,speakingRate_newSpeakers)
rm(speakingRate_newSpeakers)

dir.create("Prepped Data", showWarnings = F)
rio::export(speakingRate, file = "Prepped Data/Speaking Rate.csv", format = "csv")

```
## Articulation Rate - BBAP
```{r, eval = F}
NC <- 1

while(NC <= nrow(speakerList_BBAP)) {
  speaker_articRate_BBAP <- speakerList_BBAP %>%
    dplyr::filter(row_number() == NC)
  
  Speaker <- speaker_articRate_BBAP$Speaker
  Group <- speaker_articRate_BBAP$Group
  articRateFile <- speaker_articRate_BBAP$`BBAP File`
  DBSstatus <- speaker_articRate_BBAP$DBS_Status

filePath <- paste("DBS data/",Group,"/",Speaker,"/", sep = "")

tg <- list.files(path = filePath, pattern = paste(articRateFile,".TextGrid",sep = "")) %>%
    paste(filePath,.,sep = "") %>%
    tg.read(.)

Segments <- cbind(tg[[1]][["label"]],tg[[1]][["t1"]], tg[[1]][["t2"]]) %>%
    as.data.frame() %>%
    dplyr::rename(Segment = 1,
                  Onset = 2,
                  Offset = 3) %>%
  dplyr::filter(Segment != "") %>%
  dplyr::mutate(Speaker = Speaker,
                Group = Group,
                DBS_Status = DBSstatus) %>%
  dplyr::relocate(Speaker:DBS_Status, .before = 1)

if(NC == 1) {
  articRate <- Segments
} else {
  articRate <- articRate %>%
    rbind(., Segments)
}

NC <- NC + 1
rm(Segments, Speaker, Group, articRateFile, DBSstatus, speaker_articRate_BBAP, tg, filePath)
}

articRate_BBAP <- articRate %>%
  dplyr::mutate(Onset = as.numeric(Onset),
                Offset = as.numeric(Offset),
                Duration = Offset - Onset,
                sylCount = Segment,
                sylCount = sub(".*_", "", Segment),
                sylCount = as.numeric(sylCount),
                Segment = sub("_.*", "", Segment),
                Segment = as.factor(Segment),
                sylCount = ifelse(is.na(sylCount),6,sylCount),
                articRate = sylCount/Duration)

articRate_newSpeakers <- rio::import(file = "Raw Data/speakingRate_newSpeakerData.csv") %>%
  dplyr::select(Speaker:speakingRate) %>%
  dplyr::rename(articRate = speakingRate) %>%
  dplyr::mutate(Onset = 0,
                Offset = 0,
                Segment = "bbp")

articRate_BBAP <- base::rbind(articRate_BBAP,articRate_newSpeakers)
rm(articRate_newSpeakers)

dir.create("Prepped Data", showWarnings = F)
rio::export(articRate_BBAP, file = "Prepped Data/Artic Rate_bbap.csv", format = "csv")

```

## Speaking Rate - BBAP
```{r, eval = F}
speakingRate_BBAP.1 <- articRate_BBAP |>
  dplyr::filter(Segment != "bbp") |>
  dplyr::group_by(Speaker, Group, DBS_Status, Segment) |>
  dplyr::summarise(sylCount = sum(sylCount),
                   Onset = base::min(Onset),
                   Offset = base::max(Offset)) |>
  dplyr::ungroup() |>
  dplyr::mutate(Duration = Offset - Onset,
                SpeakingRate = sylCount/Duration)

 speakingRate_BBAP.2 <-  articRate_BBAP |>
                dplyr::filter(Segment == "bbp") |>
                dplyr::rename(SpeakingRate = articRate)
 
 speakingRate_BBAP <- rbind(speakingRate_BBAP.1,speakingRate_BBAP.2)
 
 rm(speakingRate_BBAP.1, speakingRate_BBAP.2)
 dir.create("Prepped Data", showWarnings = F)
 rio::export(speakingRate_BBAP, file = "Prepped Data/Speaking Rate_bbap.csv", format = "csv")


```

## Buy Duration
```{r}
NC <- 1

while(NC <= nrow(speakerList_BBAP)) {
  speaker_articRate_BBAP <- speakerList_BBAP %>%
    dplyr::filter(row_number() == NC)
  
  Speaker <- speaker_articRate_BBAP$Speaker
  Group <- speaker_articRate_BBAP$Group
  articRateFile <- speaker_articRate_BBAP$`BBAP File`
  DBSstatus <- speaker_articRate_BBAP$DBS_Status

filePath <- paste("DBS data/",Group,"/",Speaker,"/", sep = "")

tg <- list.files(path = filePath, pattern = paste(articRateFile,".TextGrid",sep = "")) %>%
    paste(filePath,.,sep = "") %>%
    tg.read(.)

Segments <- cbind(tg[[2]][["label"]],tg[[2]][["t1"]], tg[[2]][["t2"]]) %>%
    as.data.frame() %>%
    dplyr::rename(Segment = 1,
                  Onset = 2,
                  Offset = 3) %>%
  dplyr::filter(Segment != "") %>%
  dplyr::mutate(Speaker = Speaker,
                Group = Group,
                DBS_Status = DBSstatus) %>%
  dplyr::relocate(Speaker:DBS_Status, .before = 1)

if(NC == 1) {
  buyDur <- Segments
} else {
  buyDur <- buyDur %>%
    rbind(., Segments)
}

NC <- NC + 1
rm(Segments, Speaker, Group, articRateFile, DBSstatus, speaker_articRate_BBAP, tg, filePath)
}

buyDur <- buyDur %>%
  dplyr::mutate(Onset = as.numeric(Onset),
                Offset = as.numeric(Offset),
                Duration = Offset - Onset) |>
  dplyr::filter(Segment == "buy")

dir.create("Prepped Data", showWarnings = F)
rio::export(buyDur, file = "Prepped Data/Buy Duration.csv", format = "csv")

```


## F0 Data
```{r}
f0Data <- readxl::read_xlsx(path = "Raw Data/Results.xlsx",
                               sheet = "Prosody") |>
  dplyr::select(1:2, 4:10) |>
   dplyr::rename(Speaker = 1,
                F0_mean = 3,
                F0_min = 4,
                F0_max = 5,
                F0_std = 6,
                F0_perActive = 7,
                F0_range = 8,
                F0_Semitone = 9,
                DBS_Status = `DBS Status`) |>
  dplyr::filter(!is.na(F0_min)) |>
  dplyr::mutate(F0_mean = as.numeric(F0_mean),
                Speaker = gsub(" ","", Speaker,
                               fixed = T),
                Speaker = as.factor(Speaker),
                Group = ifelse(grepl("HC",
                                     Speaker,
                                     fixed = T), "HC", "PD"),
                Group = ifelse(grepl("DBS",
                                     Speaker,
                                     fixed = T),
                               "PD_DBS",
                               Group),
                Group = as.factor(Group),
                DBS_Status = as.factor(DBS_Status)) |>
  dplyr::relocate(Group, .after = Speaker)

dir.create("Prepped Data", showWarnings = F)
rio::export(f0Data, file = "Prepped Data/F0 Data.csv", format = "csv")
```

## dB Data
```{r}
dBData <- readxl::read_xlsx(path = "Raw Data/Results.xlsx",
                               sheet = "Prosody") |>
  dplyr::select(1:2, 13:17) |>
   dplyr::rename(Speaker = 1,
                dB_mean = 3,
                dB_min = 4,
                dB_max = 5,
                dB_std = 6,
                dB_range = 7,
                DBS_Status = `DBS Status`) |>
  dplyr::filter(!is.na(dB_min)) |>
  dplyr::mutate(Speaker = gsub(" ","", Speaker,
                               fixed = T),
                Speaker = as.factor(Speaker),
                Group = ifelse(grepl("HC",
                                     Speaker,
                                     fixed = T), "HC", "PD"),
                Group = ifelse(grepl("DBS",
                                     Speaker,
                                     fixed = T),
                               "PD_DBS",
                               Group),
                Group = as.factor(Group),
                DBS_Status = as.factor(DBS_Status)) |>
  dplyr::relocate(Group, .after = Speaker)

dir.create("Prepped Data", showWarnings = F)
rio::export(dBData, file = "Prepped Data/dB Data.csv", format = "csv")
```

# Perceptual Data
## Load the Data
First survey
```{r}
perceptualData <- rio::import(file = paste("Raw Data/",
                                           list.files(path = "Raw Data",
                                                      pattern = "Perceptual Study_October"),
                                           sep = ""),
                              header = FALSE)

perceptualData[2,1:32] <- NA
perceptualData[2,] <- sub('\\-.*', '', perceptualData[2,])
perceptualData[1,33:352] <- NA
perceptualData[3,] <- NA
# Rating Type
perceptualData[3,c(33:64, 193:224)] <- "Int"
perceptualData[3,c(65:96, 225:256)] <- "LE"
perceptualData[3,c(97:128, 257:288)] <- "AP"
perceptualData[3,c(129:160, 289:320)] <- "VQ"
perceptualData[3,c(161:192, 321:352)] <- "Pro"

headings <- as.data.frame(lapply(perceptualData[1:3,], paste,collapse="_")) %>%
    str_remove_all(" ") %>%
    str_remove_all("_NA") %>%
    str_remove_all("NA_") %>%
    t() %>%
    as.data.frame()
colnames(perceptualData) <- headings
    perceptualData <- perceptualData[-c(1:3),]
    
    rm(headings)
    
    
perceptualData <- perceptualData |>
  dplyr::rename(class = 19,
                class_other = Q1_6_TEXT,
                email = 21,
                inUS = 22,
                english = 23,
                age = 24,
                gender = 25,
                gender_other = 26,
                race = 27,
                race_other = 28,
                ethnicity = 29,
                audioCheck = 30) |>
  dplyr::select(!c(32, StartDate:EndDate,IPAddress,ResponseId:UserLanguage)) |>
  dplyr::filter(Finished == "True") |>
  dplyr::filter(Status == "IP Address") |>
  dplyr::filter(english == "Yes, it is my native language") |>
  dplyr::mutate(across(.cols=20:339, .fns=as.numeric)) |>
  dplyr::mutate(ListenerID = paste("L",row_number(), sep = ""),
                ListenerID = as.factor(ListenerID)) |>
  dplyr::relocate(ListenerID, .before = 1)

listenerDemo_1 <- perceptualData |>
  dplyr::select(ListenerID:Headphones)

listenerRatings_1 <- perceptualData |>
  dplyr::select(ListenerID,HC1_Int:PDDBS9_On_Rel_Pro) |>
  tidyr::pivot_longer(cols = `HC1_Int`:`PDDBS9_On_Rel_Pro`,
                      names_to = "RatingID",
                      values_to = "Rating") |>
  dplyr::filter(!is.na(Rating)) |>
  dplyr::mutate(
    # Making the Rating Type column
    ratingType = case_when(
      grepl(pattern = "_Int",
            fixed = T,
            x = RatingID) ~ "Int",
      grepl(pattern = "_LE",
            fixed = T,
            x = RatingID) ~ "LE",
      grepl(pattern = "_AP",
            fixed = T,
            x = RatingID) ~ "AP",
      grepl(pattern = "_VQ",
            fixed = T,
            x = RatingID) ~ "VQ",
      grepl(pattern = "_Pro",
            fixed = T,
            x = RatingID) ~ "Pro"),
    ratingType = as.factor(ratingType),
    
    # Making the DBS Status column
    DBS_Status = case_when(
       grepl(pattern = "_On",
          ignore.case = T,
          x = RatingID) ~ "On",
       grepl(pattern = "_Off",
          ignore.case = T,
          x = RatingID) ~ "Off"),
    DBS_Status = as.factor(DBS_Status),
    
    # Making the Speaker ID column
    Speaker = sub('\\_.*', '', RatingID),
    Speaker = as.factor(Speaker),
    
    # Making the Speaker Group column
    Group = case_when(
      grepl(pattern = "HC",
          ignore.case = T,
          x = RatingID) ~ "HC",
      grepl(pattern = "PDDBS",
          ignore.case = T,
          x = RatingID) ~ "PD_DBS",
      grepl(pattern = "PD",
          ignore.case = T,
          x = RatingID) ~ "PD"),
    Group = as.factor(Group),
    
    # Identifying Reliability Ratings
    Reliability = case_when(
      grepl(pattern = "_Rel",
            ignore.case = T,
            x = RatingID) ~ TRUE,
      TRUE ~ FALSE)
    ) |>
  dplyr::select(ListenerID, Speaker, Group, DBS_Status, ratingType, Rating, Reliability)

relRatings <- listenerRatings_1 |>
  dplyr::filter(Reliability == TRUE) |>
  dplyr::rename(Rel_Rating = Rating) |>
  dplyr::select(!Reliability)

listenerRatings_1 <- listenerRatings_1 |>
  dplyr::filter(Reliability == FALSE) |>
  dplyr::select(!Reliability) |>
  base::merge(relRatings,
              all = T)

listenerRatings_1 %>%
  dplyr::group_by(Speaker) %>%
  dplyr::summarize(NROW(unique(ListenerID)))

rm(perceptualData, relRatings)
```

Second Survey - conducted for the two new speakers
```{r}
perceptualData <- rio::import(file = paste("Raw Data/New Speaker Data/",
                                           list.files(path = "Raw Data/New Speaker Data",
                                                      pattern = "Perceptual Study"),
                                           sep = ""),
                              header = FALSE)

perceptualData[2,1:32] <- NA
perceptualData[2,] <- sub('\\-.*', '', perceptualData[2,])
perceptualData[1,33:207] <- NA
perceptualData[3,] <- NA
# Rating Type
perceptualData[3,c(33:67)] <- "Int"
perceptualData[3,c(68:102)] <- "LE"
perceptualData[3,c(103:137)] <- "AP"
perceptualData[3,c(138:172)] <- "VQ"
perceptualData[3,c(173:207)] <- "Pro"

headings <- as.data.frame(lapply(perceptualData[1:3,], paste,collapse="_")) %>%
    str_remove_all(" ") %>%
    str_remove_all("_NA") %>%
    str_remove_all("NA_") %>%
    t() %>%
    as.data.frame()
colnames(perceptualData) <- headings
    perceptualData <- perceptualData[-c(1:3),]
    
    rm(headings)
    
perceptualData <- perceptualData |>
  dplyr::rename(class = 19,
                class_other = Q1_6_TEXT,
                email = 21,
                inUS = 22,
                english = 23,
                age = 24,
                gender = 25,
                gender_other = 26,
                race = 27,
                race_other = 28,
                ethnicity = 29,
                audioCheck = 30) |>
  dplyr::select(!c(32, StartDate:EndDate,IPAddress,ResponseId:UserLanguage)) |>
  dplyr::filter(Finished == "True") |>
  dplyr::filter(Status == "IP Address") |>
  dplyr::filter(english == "Yes, it is my native language") |>
  dplyr::mutate(across(.cols=20:194, .fns=as.numeric)) |>
  dplyr::mutate(ListenerID = paste("L",row_number()+44, sep = ""),
                ListenerID = as.factor(ListenerID)) |>
  dplyr::relocate(ListenerID, .before = 1)

listenerDemo_2 <- perceptualData |>
  dplyr::select(ListenerID:Headphones)

listenerRatings_2 <- perceptualData |>
  dplyr::select(ListenerID,HC1_Int:PDDBS9_On_Pro) |>
  tidyr::pivot_longer(cols = `HC1_Int`:`PDDBS9_On_Pro`,
                      names_to = "RatingID",
                      values_to = "Rating") |>
  dplyr::filter(!is.na(Rating)) |>
  dplyr::mutate(
    # Making the Rating Type column
    ratingType = case_when(
      grepl(pattern = "_Int",
            fixed = T,
            x = RatingID) ~ "Int",
      grepl(pattern = "_LE",
            fixed = T,
            x = RatingID) ~ "LE",
      grepl(pattern = "_AP",
            fixed = T,
            x = RatingID) ~ "AP",
      grepl(pattern = "_VQ",
            fixed = T,
            x = RatingID) ~ "VQ",
      grepl(pattern = "_Pro",
            fixed = T,
            x = RatingID) ~ "Pro"),
    ratingType = as.factor(ratingType),
    
    # Making the DBS Status column
    DBS_Status = case_when(
       grepl(pattern = "_On",
          ignore.case = T,
          x = RatingID) ~ "On",
       grepl(pattern = "_Off",
          ignore.case = T,
          x = RatingID) ~ "Off"),
    DBS_Status = as.factor(DBS_Status),
    
    # Making the Speaker ID column
    Speaker = sub('\\_.*', '', RatingID),
    Speaker = as.factor(Speaker),
    
    # Making the Speaker Group column
    Group = case_when(
      grepl(pattern = "HC",
          ignore.case = T,
          x = RatingID) ~ "HC",
      grepl(pattern = "PDDBS",
          ignore.case = T,
          x = RatingID) ~ "PD_DBS",
      grepl(pattern = "PD",
          ignore.case = T,
          x = RatingID) ~ "PD"),
    Group = as.factor(Group),
    
    # Identifying Reliability Ratings
    Reliability = case_when(
      grepl(pattern = "_Rel",
            ignore.case = T,
            x = RatingID) ~ TRUE,
      TRUE ~ FALSE)
    ) |>
  dplyr::select(ListenerID, Speaker, Group, DBS_Status, ratingType, Rating, Reliability)

listenerRatings_2 <- listenerRatings_2 |>
  dplyr::filter(Reliability == FALSE) |>
  dplyr::select(!Reliability) %>%
  dplyr::mutate(Rel_Rating = NA)

rm(perceptualData)
```

Combining the two listener ratings & demographics
```{r}
listenerRatings <- base::rbind(listenerRatings_1, listenerRatings_2)
rm(listenerRatings_1, listenerRatings_2)

listenerDemo <- base::rbind(listenerDemo_1, listenerDemo_2)
rm(listenerDemo_1, listenerDemo_2)
```

```{r}
listenerRatings %>%
  dplyr::group_by(Speaker, DBS_Status, ratingType) %>%
  dplyr::summarise(N = NROW(Rating))
```

## Reliability
## Listener Reliability
```{r}
reliability <- listenerRatings |>
  # Intra-rater reliability
  dplyr::mutate(absDiff = abs(Rating - Rel_Rating),
                zDiff = abs(scale(absDiff)),
                outlier = ifelse(zDiff > 2.5,TRUE,FALSE))

print(paste("Intra-listener reliability identified ", nrow(reliability |>
                                                            dplyr::filter(outlier == TRUE)),
            " outlying ratings, out of the ", nrow(listenerRatings)," total ratings.",
            sep = ""))

reliability <- reliability |>
  dplyr::filter(outlier == FALSE | is.na(outlier)) |>
  dplyr::select(!c(outlier,absDiff,zDiff)) |>
  # Inter-rate reliability
  dplyr::group_by(Speaker, DBS_Status, ratingType) |>
  dplyr::mutate(zRating = abs(scale(Rating)))

print(paste("Inter-listener reliability identified ", nrow(reliability |>
                                                            dplyr::filter(zRating > 2.5)),
            " outlying ratings, out of the ", nrow(reliability)," total ratings.",
            sep = ""))

reliability <- reliability |>
  dplyr::filter(zRating < 2.5) |>
  dplyr::select(!zRating)

print(paste("In the end,", nrow(reliability),"ratings were used."))

listenerRatings <- reliability
```

### Exporting the Data
```{r}
dir.create(path = "Prepped Data/Perceptual Data", showWarnings = F)
rio::export(listenerRatings,
            file = "Prepped Data/Perceptual Data/Listener Ratings.csv",
            format = "csv")
rio::export(listenerDemo,
            file = "Prepped Data/Perceptual Data/Listener Demographics.csv",
            format = "csv")
  
```

## Measurer Reliability
### Intermeasurer Reliability
```{r}
speakerList <- rio::import("DBS data/Project Progress - Speakers.csv") %>%
  dplyr::rename(DBS_Status = 3) %>%
  dplyr::mutate(Sex = as.factor(Sex),
                Group = as.factor(Group),
                Speaker = as.factor(Speaker),
                DBS_Status = as.factor(DBS_Status))

speakerList_vowelRel <- speakerList |>
  dplyr::filter(VowelRel == TRUE)

NC <- 1

while(NC <= nrow(speakerList_vowelRel)) {
  speaker_vowelRel <- speakerList_vowelRel |>
        dplyr::filter(row_number() == NC)
  
  Speaker <- speaker_vowelRel$Speaker
  Group <- speaker_vowelRel$Group
  DBSstatus <- speaker_vowelRel$DBS_Status

filePath <- paste("DBS data/",Group,"/",Speaker,"/", sep = "")

pullVowel <- function(path = filePath, pattern = pattern, DBSstatus = status) {
  tg <- list.files(path = filePath, pattern = pattern) %>%
  as.data.frame() |>
  dplyr::rename(files = 1) |>
  dplyr::filter(grepl(pattern = "TextGrid",files)) |>
  dplyr::filter(grepl(pattern = DBSstatus,ignore.case = T,files)) %>%
  paste(filePath,.,sep = "") %>%
  tg.read(.)

Segments <- cbind(tg[[1]][["label"]],tg[[1]][["t1"]], tg[[1]][["t2"]]) %>%
    as.data.frame() %>%
    dplyr::rename(Segment = 1,
                  Onset = 2,
                  Offset = 3) %>%
  dplyr::filter(Segment != "") %>%
  dplyr::mutate(Speaker = as.factor(Speaker),
                Group = as.factor(Group),
                DBS_Status = as.factor(DBSstatus),
                Segment = as.factor(Segment),
                Onset = as.numeric(Onset),
                Offset = as.numeric(Offset)) %>%
  dplyr::relocate(Speaker:DBS_Status, .before = 1)

return(Segments)
}

beets_on <- pullVowel(path = filePath, pattern = "beet", DBSstatus = "On")
beets_off <- pullVowel(path = filePath, pattern = "beet", DBSstatus = "Off")

bots_on <- pullVowel(path = filePath, pattern = "bot", DBSstatus = "On")
bots_off <- pullVowel(path = filePath, pattern = "bot", DBSstatus = "Off")

bats_on <- pullVowel(path = filePath, pattern = "bat", DBSstatus = "On")
bats_off <- pullVowel(path = filePath, pattern = "bat", DBSstatus = "Off")

boots_on <- pullVowel(path = filePath, pattern = "boot", DBSstatus = "On")
boots_off <- pullVowel(path = filePath, pattern = "boot", DBSstatus = "Off")

speaker_vowels <- rbind(beets_on, beets_off,
                        bots_on, bots_off,
                        bats_on, bats_off,
                        boots_on, boots_off)

if(NC == 1) {
  relVowels <- speaker_vowels
} else {
  relVowels <- relVowels %>%
    rbind(., speaker_vowels)
}

NC <- NC + 1
rm(speaker_vowelRel,
   Speaker, Group, DBSstatus, filePath,
   beets_on, beets_off,
   bots_on, bots_off,
   bats_on, bats_off,
   boots_on, boots_off)
}

relVowels <- relVowels |>
  dplyr::mutate(Duration = Offset - Onset) |>
  dplyr::group_by(Speaker, Group, DBS_Status, Segment) |>
  dplyr::summarise(Duration = mean(Duration)) |>
  dplyr::rename(relDuration = Duration) |>
  dplyr::mutate(relDuration = relDuration*1000)

vowels <- rio::import(file = "Prepped Data/Vowel Data.csv") |>
  dplyr::mutate(Speaker = as.factor(Speaker),
                Group = as.factor(Group),
                DBS_Status = as.factor(DBS_Status),
                Word = as.factor(Word),
                Segment = case_when(
                  Word == "bat" ~ "ae",
                  Word == "beets" ~ "i",
                  Word == "boots" ~ "u",
                  Word == "bots" ~ "a"
                ),
                Segment = as.factor(Segment)) |>
  dplyr::group_by(Speaker, Group, DBS_Status, Segment) |>
  dplyr::summarise(Duration = mean(Duration)) %>%
  base::merge(.,relVowels) |>
  dplyr::mutate(diff = abs(Duration - relDuration))

vowels %>%
  dplyr::summarise(diff = mean(diff))

```

### Intra-measurer reliability
```{r}
speakerList_articRateRel <- speakerList_articRate |>
  dplyr::mutate(RelFile = paste(`Sent2 File`,"_rel", sep = "")) |>
  dplyr::slice(18:24)

NC <- 1

while(NC <= nrow(speakerList_articRateRel)) {
  speaker_articRateRel <- speakerList_articRateRel %>%
    dplyr::filter(row_number() == NC)
  
  Speaker <- speaker_articRateRel$Speaker
  Group <- speaker_articRateRel$Group
  articRateFile <- speaker_articRateRel$RelFile
  DBSstatus <- speaker_articRateRel$DBS_Status

filePath <- paste("DBS data/",Group,"/",Speaker,"/", sep = "")

tg <- list.files(path = filePath, pattern = paste(articRateFile,".TextGrid",sep = "")) %>%
    paste(filePath,.,sep = "") %>%
    tg.read(.)

Segments <- cbind(tg[[1]][["label"]],tg[[1]][["t1"]], tg[[1]][["t2"]]) %>%
    as.data.frame() %>%
    dplyr::rename(Segment = 1,
                  Onset = 2,
                  Offset = 3) %>%
  dplyr::filter(Segment != "") %>%
  dplyr::mutate(Speaker = Speaker,
                Group = Group,
                DBS_Status = DBSstatus) %>%
  dplyr::relocate(Speaker:DBS_Status, .before = 1)

if(NC == 1) {
  articRate_rel <- Segments
} else {
  articRate_rel <- articRate_rel %>%
    rbind(., Segments)
}

NC <- NC + 1
rm(Segments, Speaker, Group, articRateFile, DBSstatus, speaker_articRate, tg, filePath)
}

articRate_rel <- articRate_rel %>%
  dplyr::mutate(Onset = as.numeric(Onset),
                Offset = as.numeric(Offset),
                Duration = Offset - Onset,
                sylCount = Segment,
                sylCount = gsub("sent2","",sylCount),
                sylCount = gsub("_","",sylCount),
                sylCount = as.numeric(sylCount),
                sylCount = ifelse(is.na(sylCount),15,sylCount),
                articRate = sylCount/Duration) %>%
  dplyr::select(!Segment) |>
  dplyr::select(Speaker, Group, DBS_Status, articRate) |>
  dplyr::rename(articRate_rel = articRate) |>
  dplyr::group_by(Speaker, Group, DBS_Status) |>
  dplyr::summarise(articRate_rel = mean(articRate_rel))

articRate <- rio::import("Prepped Data/Artic Rate.csv") |>
    dplyr::mutate(Group = as.factor(Group),
                  Speaker = as.factor(Speaker),
                  DBS_Status = as.factor(DBS_Status),
                  Segment = "BabyBirds") |>
  dplyr::group_by(Speaker, Group, DBS_Status) |>
  dplyr::summarise(articRate = mean(articRate)) |>
  dplyr::ungroup() |>
  base::merge(articRate_rel) |>
  dplyr::mutate(Diff = abs(articRate - articRate_rel))


articRate |>
  dplyr::summarise(Diff = mean(Diff))
```

